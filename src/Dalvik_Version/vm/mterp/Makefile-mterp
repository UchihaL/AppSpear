# Copyright (C) 2008 The Android Open Source Project
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#
# Makefile for the Dalvik modular interpreter.  This is not currently
# integrated into the build system.
#

SHELL := /bin/sh

# Build system has TARGET_ARCH=arm, but we need the exact architecture.
# The base assumption for an ARM platform is ARMv5TE, but we may want to
# support older ARMv4 devices, or use special features from ARMv6 or VFP.
# The simulator build is "desktop".
#
# To generate sources for all targets:
# for arch in desktop armv5te; do TARGET_ARCH_EXT=$arch make -f Makefile-mterp; done
#
#TARGET_ARCH_EXT := armv5te

OUTPUT_DIR := out

# Accumulate all possible dependencies for the generated files in a very
# conservative fashion.  If it's not one of the generated files in "out",
# assume it's a dependency.
SOURCE_DEPS := \
	$(shell find . -path ./$(OUTPUT_DIR) -prune -o -type f -print) \
	../Android.mk ../../Android.mk

# Source files generated by the script.  There's always one C and one
# assembly file, though in practice one or the other could be empty.
GEN_SOURCES := \
	$(OUTPUT_DIR)/InterpC-$(TARGET_ARCH_EXT).c \
	$(OUTPUT_DIR)/InterpAsm-$(TARGET_ARCH_EXT).S

target: $(GEN_SOURCES)

$(GEN_SOURCES): $(SOURCE_DEPS)
	@mkdir -p out
	./gen-mterp.py $(TARGET_ARCH_EXT) $(OUTPUT_DIR)
